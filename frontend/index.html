<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ALMAS AI</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<style>
/* --- VARIABLES & RESET --- */
:root {
  --bg-deep: #090a0f;
  --bg-sidebar: #13161f;
  --bg-surface: #1e222d;
  --bg-surface-hover: #2a2f3e;
  --primary-gradient: linear-gradient(135deg, #4c8bf5 0%, #d96570 100%);
  --glass: rgba(255, 255, 255, 0.05);
  --border: rgba(255, 255, 255, 0.08);
  --text-main: #ececf1;
  --text-sub: #9b9ca1;
  --shadow: 0 10px 40px -10px rgba(0,0,0,0.5);
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: 'Outfit', sans-serif;
  background: var(--bg-deep);
  color: var(--text-main);
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* Custom Scrollbar */
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: #555; }

/* --- SIDEBAR --- */
aside {
  width: 280px;
  background: var(--bg-sidebar);
  padding: 20px;
  display: flex;
  flex-direction: column;
  border-right: 1px solid var(--border);
  transition: transform 0.3s ease;
  z-index: 100;
}

.brand {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 25px;
  letter-spacing: -0.5px;
  background: linear-gradient(to right, #fff, #aaa);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.brand i {
  font-size: 20px;
  background: var(--primary-gradient);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.new-chat-btn {
  background: var(--bg-surface);
  color: var(--text-main);
  border: 1px solid var(--border);
  padding: 12px 15px;
  border-radius: 12px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  margin-bottom: 20px;
}

.new-chat-btn:hover {
  background: var(--bg-surface-hover);
  transform: translateY(-1px);
  border-color: #4c8bf5;
}

#history {
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.history-item {
  padding: 12px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  color: var(--text-sub);
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.2s;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.history-item:hover {
  background: var(--glass);
  color: #fff;
}

.history-item.active {
  background: rgba(76, 139, 245, 0.15);
  color: #6ba6ff;
  font-weight: 500;
}

.delete-btn {
  opacity: 0;
  background: none;
  border: none;
  color: var(--text-sub);
  cursor: pointer;
  transition: 0.2s;
}

.history-item:hover .delete-btn { opacity: 1; }
.delete-btn:hover { color: #ff5f5f; }

/* --- MAIN CHAT AREA --- */
main {
  flex: 1;
  display: flex;
  flex-direction: column;
  position: relative;
  background: radial-gradient(circle at 50% 0%, #1e2230 0%, #090a0f 60%);
}

#chat {
  flex: 1;
  overflow-y: auto;
  padding: 40px 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  scroll-behavior: smooth;
}

/* Welcome Screen */
.welcome-screen {
  text-align: center;
  margin-top: 10vh;
  animation: fadeIn 0.8s ease;
}

.welcome-screen h1 {
  font-size: 42px;
  font-weight: 600;
  background: linear-gradient(to right, #4c8bf5, #d96570);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 10px;
}

.welcome-screen p {
  color: var(--text-sub);
  font-size: 16px;
}

/* --- UPDATED MESSAGES --- */
.msg {
  width: 100%;
  max-width: 768px;
  display: flex;
  gap: 20px;
  margin-bottom: 30px;
  animation: slideUp 0.3s ease;
}

/* User Message: Avatar on Right, Text Aligned Right */
.msg.user {
  flex-direction: row-reverse;
}

.msg.user .content {
  text-align: right;
}
/* Ensure code blocks stay left aligned for readability even in user msg */
.msg.user .content pre, 
.msg.user .content ul, 
.msg.user .content ol {
    text-align: left;
    direction: ltr;
}

/* Bot Message: Standard Left Alignment */
.msg.bot {
  flex-direction: row;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.avatar {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  flex-shrink: 0;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

.user-avatar { background: #333; color: #fff; }
.bot-avatar { 
  background: var(--primary-gradient); 
  color: #fff;
}

.content {
  flex: 1;
  line-height: 1.7;
  font-size: 16px;
  color: var(--text-main);
  overflow-wrap: break-word;
}

/* Markdown Styles */
.content h1, .content h2, .content h3 { margin-top: 20px; color: #fff; }
.content p { margin-bottom: 10px; }
.content code {
  background: rgba(255,255,255,0.1);
  padding: 2px 6px;
  border-radius: 4px;
  font-family: 'Consolas', monospace;
  font-size: 0.9em;
}
.content pre {
  background: #161b22;
  padding: 15px;
  border-radius: 12px;
  overflow-x: auto;
  border: 1px solid #30363d;
  margin: 15px 0;
}

/* --- INPUT AREA --- */
.input-area {
  padding: 20px;
  background: linear-gradient(to top, var(--bg-deep) 0%, transparent 100%);
  display: flex;
  justify-content: center;
}

.input-container {
  width: 100%;
  max-width: 768px;
  position: relative;
  background: var(--bg-surface);
  border-radius: 16px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  display: flex;
  align-items: center;
  padding: 8px 10px 8px 20px;
  transition: border-color 0.2s;
}

.input-container:focus-within {
  border-color: #4c8bf5;
}

.input-container input {
  flex: 1;
  background: transparent;
  border: none;
  color: #fff;
  font-size: 16px;
  outline: none;
  padding: 10px 0;
}

.send-btn {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  border: none;
  background: var(--text-main); /* White/Grey */
  color: var(--bg-deep);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  transition: all 0.2s;
  margin-left: 10px;
}

.send-btn:hover {
  background: #fff;
  transform: scale(1.05);
}

.send-btn:disabled {
  background: #444;
  color: #888;
  cursor: default;
  transform: none;
}

/* Typing Animation */
.typing-indicator {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 10px 0;
}
.typing-dot {
  width: 6px;
  height: 6px;
  background: #aaa;
  border-radius: 50%;
  animation: bounce 1.4s infinite ease-in-out both;
}
.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes bounce {
  0%, 80%, 100% { transform: scale(0); }
  40% { transform: scale(1); }
}
</style>
</head>
<body>

<aside id="sidebar">
  <div class="brand">
    <i class="fas fa-sparkles"></i> ALMAS AI
  </div>
  <button class="new-chat-btn" onclick="newChat()">
    <i class="fas fa-plus"></i> New Chat
  </button>
  <div id="history">
    </div>
</aside>

<main>
  <div id="chat">
    </div>

  <div class="input-area">
    <div class="input-container">
      <input 
        id="input" 
        type="text" 
        placeholder="Ask Almas anything..." 
        autocomplete="off"
        onkeydown="if(event.key==='Enter') send()"
      />
      <button id="sendBtn" class="send-btn" onclick="send()">
        <i class="fas fa-arrow-up"></i>
      </button>
    </div>
  </div>
</main>

<script>
/* Config: Point this to your actual backend. 
   If running locally, keep localhost:3000 
*/
const API = "https://almas-fullstack.onrender.com/api";

let currentChat = null;
let isBusy = false;

window.onload = () => {
  loadHistory();
  // Don't auto-create new chat, wait for user or load last
  newChat(); 
};

// --- LOGIC ---

async function loadHistory() {
  try {
    const res = await fetch(API + "/chats");
    const chats = await res.json();
    const container = document.getElementById("history");
    container.innerHTML = "";
    
    chats.forEach(c => {
      const div = document.createElement("div");
      div.className = `history-item ${c.chatId === currentChat ? 'active' : ''}`;
      div.innerHTML = `
        <span style="overflow:hidden; text-overflow:ellipsis;">
          <i class="far fa-message" style="margin-right:8px; font-size:12px;"></i>
          ${c.title || "New Conversation"}
        </span>
        <button class="delete-btn" onclick="deleteChat('${c.chatId}', event)">
          <i class="fas fa-trash-alt"></i>
        </button>
      `;
      div.onclick = () => loadChat(c.chatId);
      container.appendChild(div);
    });
  } catch (e) {
    console.error("Failed to load history", e);
  }
}

async function deleteChat(id, e) {
  e.stopPropagation();
  if(!confirm("Delete this chat?")) return;
  
  await fetch(API + "/chat/" + id, { method: "DELETE" });
  if (currentChat === id) newChat();
  else loadHistory();
}

async function newChat() {
  currentChat = null;
  document.getElementById("chat").innerHTML = `
    <div class="welcome-screen">
      <h1>Hello, I am Almas.</h1>
      <p>How can I help you today?</p>
    </div>
  `;
  // Create the session on the server immediately or wait for first message
  // Implementation depends on your backend, but let's assume we create it now:
  const res = await fetch(API + "/new-chat", { method: "POST" });
  const data = await res.json();
  currentChat = data.chatId;
  loadHistory();
}

async function loadChat(id) {
  currentChat = id;
  loadHistory(); // Refresh active state
  
  const res = await fetch(API + "/chat/" + id);
  const data = await res.json();
  const chatDiv = document.getElementById("chat");
  chatDiv.innerHTML = ""; // clear welcome screen
  
  data.messages.forEach(m => appendMessage(m.role, m.content));
}

async function send() {
  const input = document.getElementById("input");
  const text = input.value.trim();
  if (!text || isBusy) return;

  isBusy = true;
  document.getElementById("sendBtn").disabled = true;
  
  // Clear welcome screen if it exists
  const welcome = document.querySelector(".welcome-screen");
  if(welcome) welcome.remove();

  appendMessage("user", text);
  input.value = "";

  // Add placeholder for bot response
  const typingId = appendTyping();

  try {
    const res = await fetch(API + "/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ chatId: currentChat, message: text })
    });
    
if (!res.ok) {
  const errorText = await res.text();
  throw new Error(errorText);
}
    const data = await res.json();

    // Remove typing indicator
    const typingDiv = document.getElementById(typingId);
    if(typingDiv) typingDiv.remove();

    // Stream the real response
    streamMessage(data.reply);
    
    // Refresh history titles
    loadHistory();

  } catch (err) {
    console.error(err);
    document.getElementById(typingId).innerHTML = `<div style="color:red">Error connecting to Almas.</div>`;
  }
  
  isBusy = false;
  document.getElementById("sendBtn").disabled = false;
  // Keep focus on input
  setTimeout(() => input.focus(), 100);
}

function appendMessage(role, text) {
  const chat = document.getElementById("chat");
  const div = document.createElement("div");
  // UPDATED: added 'role' to class list for specific alignment
  div.className = `msg ${role}`; 
  div.innerHTML = `
    <div class="avatar ${role === 'user' ? 'user-avatar' : 'bot-avatar'}">
      <i class="fas ${role === 'user' ? 'fa-user' : 'fa-sparkles'}"></i>
    </div>
    <div class="content">
      ${role === 'bot' ? marked.parse(text) : text}
    </div>
  `;
  chat.appendChild(div);
  
  // Highlight code blocks
  div.querySelectorAll("pre code").forEach(block => hljs.highlightElement(block));
  
  chat.scrollTop = chat.scrollHeight;
}

function appendTyping() {
  const chat = document.getElementById("chat");
  const id = "typing-" + Date.now();
  const div = document.createElement("div");
  // UPDATED: Added 'bot' class
  div.className = "msg bot"; 
  div.id = id;
  div.innerHTML = `
    <div class="avatar bot-avatar"><i class="fas fa-sparkles"></i></div>
    <div class="content">
      <div class="typing-indicator">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    </div>
  `;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return id;
}

/* Smoother streaming effect 
   Instead of re-parsing Markdown on every character (which glitches),
   we parse chunks or just simple text, then finalize.
   For simplicity and stability, we will simulate typing then render Markdown.
*/
function streamMessage(fullText) {
  const chat = document.getElementById("chat");
  const div = document.createElement("div");
  // UPDATED: Added 'bot' class
  div.className = "msg bot"; 
  div.innerHTML = `
    <div class="avatar bot-avatar"><i class="fas fa-sparkles"></i></div>
    <div class="content"></div>
  `;
  chat.appendChild(div);
  
  const contentDiv = div.querySelector(".content");
  let index = 0;
  
  // Speed up the typing slightly
  const interval = setInterval(() => {
    contentDiv.innerText = fullText.slice(0, index); // Plain text while typing
    chat.scrollTop = chat.scrollHeight;
    index += 5; // Type 5 chars at a time
    
    if (index > fullText.length) {
      clearInterval(interval);
      // Final render with Markdown
      contentDiv.innerHTML = marked.parse(fullText);
      div.querySelectorAll("pre code").forEach(block => hljs.highlightElement(block));
      chat.scrollTop = chat.scrollHeight;
    }
  }, 10);
}
</script>

</body>
</html>